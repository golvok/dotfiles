#!/usr/bin/env bash
the_MAC='28:18:78:60:BB:63'

function retry_until_message() {
	echo -n "$1"
	for ((i=0; i<120; ++i)); do
		echo -n '.'
		bluetoothctl $2 | tee /dev/stdout | grep $4 "$3" > /dev/null && echo && return 0
		sleep .5
	done
	echo "failed!"
	return 1
}

rfkill unblock bluetooth

sudo --non-interactive reset-bluetooth

retry_until_message "Waiting for power on" "power on" "Changing power on succeeded"

bluetoothctl remove "$the_MAC"
bluetoothctl --timeout 60 scan on &

retry_until_message "Waiting for device to show up" "devices" "$the_MAC"
retry_until_message "Waiting for connection" "connect $the_MAC" "Connection successful"

kill %1
